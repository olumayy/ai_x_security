#!/usr/bin/env python3
"""Tests for Lab 02: Malware Sample Clustering."""

import numpy as np
import pytest

# Try to import from solution, fall back to starter
try:
    from labs.lab02_malware_clustering.solution.main import (
        MalwareSample,
        analyze_clusters,
        cluster_with_dbscan,
        cluster_with_hierarchical,
        cluster_with_kmeans,
        combine_features,
        evaluate_clustering,
        extract_behavioral_features,
        extract_static_features,
    )
except ImportError:
    try:
        from solution.main import (
            MalwareSample,
            analyze_clusters,
            cluster_with_dbscan,
            cluster_with_hierarchical,
            cluster_with_kmeans,
            combine_features,
            evaluate_clustering,
            extract_behavioral_features,
            extract_static_features,
        )
    except ImportError:
        pytest.skip("Solution module not available", allow_module_level=True)


# =============================================================================
# Fixtures
# =============================================================================


@pytest.fixture
def sample_malware():
    """Create a test malware sample."""
    return MalwareSample(
        sha256="abc123def456",
        file_size=102400,
        imports=["kernel32.dll", "user32.dll", "ws2_32.dll"],
        sections=[".text", ".data", ".rsrc"],
        strings=["http://evil.com", "cmd.exe /c", "password"],
        api_calls=["CreateProcess", "WriteFile", "socket"],
        network_iocs=["evil.com", "192.168.1.1"],
        file_operations=["create", "write", "delete"],
        registry_operations=["HKLM\\SOFTWARE\\Run"],
        family="emotet",
    )


@pytest.fixture
def sample_dataset():
    """Create a test dataset for clustering."""
    np.random.seed(42)
    # Create 3 clusters
    cluster1 = np.random.randn(30, 4) + [0, 0, 0, 0]
    cluster2 = np.random.randn(30, 4) + [5, 5, 5, 5]
    cluster3 = np.random.randn(30, 4) + [10, 0, 10, 0]
    return np.vstack([cluster1, cluster2, cluster3])


# =============================================================================
# Feature Extraction Tests
# =============================================================================


class TestFeatureExtraction:
    """Test feature extraction functions."""

    def test_extract_static_features(self, sample_malware):
        """Test static feature extraction."""
        features = extract_static_features(sample_malware)
        assert isinstance(features, np.ndarray)
        assert len(features) == 4
        assert features[0] == 102400  # file_size
        assert features[1] == 3  # num imports
        assert features[2] == 3  # num sections
        assert features[3] == 3  # num strings

    def test_extract_behavioral_features(self, sample_malware):
        """Test behavioral feature extraction."""
        features = extract_behavioral_features(sample_malware)
        assert isinstance(features, np.ndarray)
        assert len(features) == 4
        assert features[0] == 3  # api_calls
        assert features[1] == 2  # network_iocs
        assert features[2] == 3  # file_operations
        assert features[3] == 1  # registry_operations

    def test_combine_features(self, sample_malware):
        """Test feature combination."""
        static = extract_static_features(sample_malware)
        behavioral = extract_behavioral_features(sample_malware)
        combined = combine_features(static, behavioral)
        assert len(combined) == 8
        assert combined[0] == 102400  # First static feature
        assert combined[4] == 3  # First behavioral feature


# =============================================================================
# Clustering Tests
# =============================================================================


class TestClustering:
    """Test clustering algorithms."""

    def test_kmeans_clustering(self, sample_dataset):
        """Test K-means clustering."""
        labels, model = cluster_with_kmeans(sample_dataset, n_clusters=3)
        assert len(labels) == len(sample_dataset)
        assert len(set(labels)) == 3
        assert model is not None

    def test_dbscan_clustering(self, sample_dataset):
        """Test DBSCAN clustering."""
        labels = cluster_with_dbscan(sample_dataset, eps=2.0, min_samples=5)
        assert len(labels) == len(sample_dataset)
        # DBSCAN may find different number of clusters
        assert len(set(labels)) >= 1

    def test_hierarchical_clustering(self, sample_dataset):
        """Test hierarchical clustering."""
        labels, _ = cluster_with_hierarchical(sample_dataset, n_clusters=3)
        assert len(labels) == len(sample_dataset)
        assert len(set(labels)) == 3


# =============================================================================
# Evaluation Tests
# =============================================================================


class TestEvaluation:
    """Test clustering evaluation."""

    def test_evaluate_with_ground_truth(self, sample_dataset):
        """Test evaluation with ground truth labels."""
        true_labels = [0] * 30 + [1] * 30 + [2] * 30
        pred_labels, _ = cluster_with_kmeans(sample_dataset, n_clusters=3)

        metrics = evaluate_clustering(true_labels, pred_labels, has_ground_truth=True)
        assert "ari" in metrics or "adjusted_rand_score" in metrics
        # ARI should be positive for well-separated clusters
        score = metrics.get("ari", metrics.get("adjusted_rand_score", 0))
        assert score > 0

    def test_evaluate_without_ground_truth(self, sample_dataset):
        """Test evaluation without ground truth (silhouette)."""
        pred_labels, _ = cluster_with_kmeans(sample_dataset, n_clusters=3)

        metrics = evaluate_clustering(None, pred_labels, X=sample_dataset, has_ground_truth=False)
        assert "silhouette" in metrics or "silhouette_score" in metrics
        score = metrics.get("silhouette", metrics.get("silhouette_score", 0))
        # Silhouette should be positive for well-separated clusters
        assert score > 0


# =============================================================================
# Analysis Tests
# =============================================================================


class TestAnalysis:
    """Test cluster analysis functions."""

    def test_analyze_clusters(self, sample_malware):
        """Test cluster analysis with sample list."""
        samples = [sample_malware for _ in range(10)]
        labels = np.array([0, 0, 0, 0, 0, 1, 1, 1, 1, 1])

        analysis = analyze_clusters(samples, labels)
        assert isinstance(analysis, dict)
        assert 0 in analysis
        assert 1 in analysis
        assert analysis[0]["size"] == 5
        assert analysis[1]["size"] == 5


# =============================================================================
# Edge Cases
# =============================================================================


class TestEdgeCases:
    """Test edge cases."""

    def test_single_sample(self):
        """Test with single sample."""
        X = np.array([[1, 2, 3, 4]])
        # DBSCAN should mark single point as noise
        labels = cluster_with_dbscan(X, eps=0.5, min_samples=2)
        assert labels[0] == -1  # Noise

    def test_identical_samples(self):
        """Test with identical samples."""
        X = np.array([[1, 1, 1, 1]] * 10)
        labels, _ = cluster_with_kmeans(X, n_clusters=1)
        assert len(set(labels)) == 1


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
