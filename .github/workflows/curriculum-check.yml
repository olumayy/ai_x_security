name: Curriculum Integrity Check

on:
  # Run weekly on Sundays at midnight UTC
  schedule:
    - cron: '0 0 * * 0'

  # Run on pushes to main that affect curriculum content
  push:
    branches: [main]
    paths:
      - 'labs/**'
      - 'notebooks/**'
      - 'docs/**'
      - 'ctf-challenges/**'
      - 'tests/test_curriculum_integrity.py'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      full_check:
        description: 'Run full check including link validation'
        required: false
        default: 'false'
        type: boolean

# Restrict permissions to minimum required (OpenSSF Scorecard requirement)
permissions:
  contents: read

jobs:
  curriculum-tests:
    name: Curriculum Integrity Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest==9.0.2 pytest-html==4.1.1

      - name: Run curriculum integrity tests
        run: |
          pytest tests/test_curriculum_integrity.py -v \
            --html=curriculum-report.html \
            --self-contained-html

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: curriculum-report
          path: curriculum-report.html
          retention-days: 30

  link-check:
    name: Link Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Only run on schedule or manual trigger with full_check
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.full_check == 'true')

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@d53a906aa6b22b8979d33bc86170567e619495ec # v1.0.15
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/mlc-config.json'
          folder-path: 'docs/, labs/, ctf-challenges/'

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    permissions:
      issues: write
    needs: [curriculum-tests]
    if: failure() && github.event_name == 'schedule'

    steps:
      - name: Create issue on failure
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const title = `Curriculum Check Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Scheduled Curriculum Check Failed

            The weekly curriculum integrity check has detected issues.

            **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            Please review the test report and fix any issues found.

            ### Common Issues
            - Lab header numbers not matching folder names
            - Broken walkthrough references
            - Missing README files in labs or challenges
            - Outdated package versions in guides

            ### How to Fix
            1. Download the test report artifact
            2. Review failing tests
            3. Make necessary corrections
            4. Push fixes to main branch
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'curriculum-check'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['curriculum-check', 'automated']
              });
            }
